@page
@model PRN232_FA25_Assignment_G7.RazorPages.Pages.Admin.BulkUpload.IndexModel
@{
    ViewData["Title"] = "Bulk Upload Submissions";
}

<h1>@ViewData["Title"]</h1>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Upload Student Submissions Archive</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="bulkUploadForm">
                    <div class="mb-3">
                        <label for="examId" class="form-label">Select Exam</label>
                        <select class="form-select" id="examId" name="examId" required>
                            <option value="">Choose an exam...</option>
                            @foreach (var exam in Model.Exams)
                            {
                                <option value="@exam.Id">@exam.Name (@exam.SubjectName)</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="file" class="form-label">Archive File (.rar, .zip, .7z)</label>
                        <input type="file" class="form-control" id="file" name="file"
                               accept=".rar,.zip,.7z,.tar,.gz" required>
                        <div class="form-text">
                            Upload a compressed archive containing student submission folders.
                            Each student should have their own folder named with their student code.
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="uploadBtn">
                        <i class="fas fa-upload me-2"></i>Start Bulk Upload
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Upload Guidelines</h5>
            </div>
            <div class="card-body">
                <h6>Archive Structure:</h6>
                <pre class="bg-light p-2 small">Archive.zip/
├── SE123456/
│   ├── Program.cs
│   └── README.txt
├── SE123457/
│   ├── Main.java
│   └── Report.docx
└── SE123458/
    └── solution.py</pre>

                <h6 class="mt-3">Supported Formats:</h6>
                <ul class="small">
                    <li>RAR (.rar)</li>
                    <li>ZIP (.zip)</li>
                    <li>7-Zip (.7z)</li>
                    <li>TAR (.tar)</li>
                    <li>GZIP (.gz)</li>
                </ul>

                <h6 class="mt-3">Automatic Processing:</h6>
                <ul class="small">
                    <li>✅ File extraction</li>
                    <li>✅ Naming convention validation</li>
                    <li>✅ Source code violation detection</li>
                    <li>✅ Duplicate content detection</li>
                    <li>✅ Word document image extraction</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Bulk Upload Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <div id="progressStatus" class="alert alert-info">
                    Preparing upload...
                </div>

                <div class="row text-center mt-3">
                    <div class="col-3">
                        <div class="border-end">
                            <h4 id="totalFiles">0</h4>
                            <small class="text-muted">Total Files</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border-end">
                            <h4 id="processedFiles">0</h4>
                            <small class="text-muted">Processed</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border-end">
                            <h4 id="violationsFound">0</h4>
                            <small class="text-muted">Violations</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <h4 id="duplicatesFound">0</h4>
                        <small class="text-muted">Duplicates</small>
                    </div>
                </div>

                <div id="errorsContainer" class="mt-3" style="display: none;">
                    <h6>Errors:</h6>
                    <div id="errorsList" class="alert alert-danger small"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        let connection;
        let currentExamId;

        document.getElementById('bulkUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            currentExamId = formData.get('ExamId');

            // Show progress modal
            const modal = new bootstrap.Modal(document.getElementById('progressModal'));
            modal.show();

            // Disable form
            document.getElementById('uploadBtn').disabled = true;

            // Start SignalR connection
            startSignalR();

            // Submit upload
            fetch('/api/submissions/bulk-upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.errors && data.errors.length > 0) {
                    showErrors(data.errors);
                } else {
                    showSuccess(data);
                }
            })
            .catch(error => {
                showErrors([error.message]);
            })
            .finally(() => {
                document.getElementById('uploadBtn').disabled = false;
            });
        });

        function startSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl('/submissionHub')
                .build();

            connection.on('BulkUploadProgress', function(progress) {
                if (progress.examId === currentExamId) {
                    updateProgress(progress);
                }
            });

            connection.on('BulkUploadCompleted', function(data) {
                if (data.examId === currentExamId) {
                    showCompletion(data.result);
                }
            });

            connection.start().catch(function(err) {
                console.error(err.toString());
            });
        }

        function updateProgress(progress) {
            document.getElementById('progressStatus').textContent = progress.status;
            document.getElementById('totalFiles').textContent = progress.totalFiles;
            document.getElementById('processedFiles').textContent = progress.processedFiles;
            document.getElementById('violationsFound').textContent = progress.violationsFound;
            document.getElementById('duplicatesFound').textContent = progress.duplicatesFound;

            const percentage = progress.totalFiles > 0 ? (progress.processedFiles / progress.totalFiles) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';

            if (progress.errors && progress.errors.length > 0) {
                showErrors(progress.errors);
            }
        }

        function showCompletion(result) {
            document.getElementById('progressStatus').innerHTML =
                `<div class="alert alert-success">Bulk upload completed! Processed ${result.successfulUploads} submissions.</div>`;

            if (result.errors && result.errors.length > 0) {
                showErrors(result.errors);
            }
        }

        function showErrors(errors) {
            const container = document.getElementById('errorsContainer');
            const list = document.getElementById('errorsList');
            list.innerHTML = errors.map(error => `<div>${error}</div>`).join('');
            container.style.display = 'block';
        }

        function showSuccess(data) {
            // Redirect to results page or show success message
            window.location.href = '/Admin/Submissions?examId=' + currentExamId;
        }
    </script>
}